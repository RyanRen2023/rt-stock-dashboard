# Stock Subscription GraphQL Server

## Project Overview
This project is a **GraphQL WebSocket subscription service** built with **Go + gqlgen**. It supports:
- **Stock Query (`Query`)**
- **Subscribe to Stock Price (`Subscription` + WebSocket)**

When stock prices change, the server will push the latest prices to all subscribers via **WebSocket**.

---

## Technology Stack
- **Go** (`1.20+`)
- **GraphQL + gqlgen** (Auto-generates GraphQL code)
- **WebSocket** (For real-time data updates)
- **REST API + GraphQL Subscription** (Supports HTTP queries and real-time subscriptions)

---

## Directory Structure
```
graphql-server
├── Dockerfile                 # Docker file
├── README.md                  # Project documentation
├── go.mod                     # Go module dependencies
├── go.sum                     # Go dependency lock file
├── gqlgen.yml                 # gqlgen configuration file
├── graph                      # GraphQL processing layer
│   ├── generated.go           # GraphQL handling logic generated by gqlgen
│   ├── model
│   │   └── models_gen.go      # Data models generated by gqlgen
│   ├── resolver.go            # Entry point for resolvers
│   ├── schema.graphqls        # GraphQL schema definition
│   └── schema.resolvers.go    # Implementation of GraphQL resolvers
├── server.go                  # HTTP server (runs GraphQL API)
└── stock_client               # Stock data fetching module
    ├── stock_client.go        # HTTP API client for stock data
    └── stock_client_test.go   # Unit tests
```

---

## Installation & Running the Server

### 1. Install Go Dependencies
Run the following command to install the necessary Go dependencies:

```sh
go mod tidy
```

### 2. Generate GraphQL Code
If the `graph/` directory does not exist, generate GraphQL code using gqlgen:

```sh
go run github.com/99designs/gqlgen generate
```

This command will:
- Generate `graph/generated.go` and `graph/model/models_gen.go` based on `schema.graphqls`
- Create `schema.resolvers.go` for implementing resolvers

### 3. Run the GraphQL Server
To start the server, run:

```sh
go run server.go
```

Once started, open the GraphQL Playground in your browser:

```
http://localhost:8080/
```

---

## Usage Guide

### Query Stock Information
To query stock information, use the following GraphQL query:

```graphql
query {
  stock(stockCode: "AAPL") {
    symbol
    price
    exchange
    updatedAt
  }
}
```

Example Response:
```json
{
  "data": {
    "stock": {
      "symbol": "AAPL",
      "price": 152.34,
      "exchange": "NASDAQ",
      "updatedAt": "2025-02-27T14:30:00Z"
    }
  }
}
```

---

### Subscribe to Stock Price Updates
To receive real-time updates when a stock price changes, use the following GraphQL subscription:

```graphql
subscription {
  stockPriceUpdated(stockCode: "AAPL") {
    symbol
    price
  }
}
```

When the stock price for `AAPL` updates, the server will push the new price:

```json
{
  "data": {
    "stockPriceUpdated": {
      "symbol": "AAPL",
      "price": 153.25
    }
  }
}
```

Multiple clients can subscribe simultaneously, and the server will broadcast updates.

---

### Update Stock Price
To update the stock price manually, use the following GraphQL mutation:

```graphql
mutation {
  updateStockPrice(stockCode: "AAPL", price: 155.00) {
    symbol
    price
  }
}
```

Example Response:
```json
{
  "data": {
    "updateStockPrice": {
      "symbol": "AAPL",
      "price": 155.00
    }
  }
}
```

After updating, all subscribers will immediately receive the latest `AAPL` price.

---

## Using gqlgen to Generate Code
If the `graph/` directory does not exist, or if you modify `schema.graphqls`, you need to regenerate gqlgen code:

```sh
go run github.com/99designs/gqlgen generate
```

This command automatically generates:
```
graph
├── generated.go       # GraphQL handling logic generated by gqlgen
├── model
│   └── models_gen.go  # Data models generated by gqlgen
├── resolver.go        # Entry point for resolvers (manually written)
├── schema.graphqls    # GraphQL schema definition
└── schema.resolvers.go # Resolver implementation (manually written)
```

You only need to modify `schema.resolvers.go` to implement business logic.

---

## Docker Deployment (Optional)
### 1. Build Docker Image
To containerize the application, run:

```sh
docker build -t stock-subscription-server .
```

### 2. Run the Container
```sh
docker run -p 8080:8080 stock-subscription-server
```

The server will be available at:
```
http://localhost:8080/
```

---

## Development Guide

### 1. Modify GraphQL Schema
Edit `graph/schema.graphqls`, then regenerate gqlgen code:

```sh
go run github.com/99designs/gqlgen generate
```

### 2. Run Unit Tests
To test the stock client module and other components, run:

```sh
go test ./...
```

---

## Related Resources
- gqlgen Official Documentation: [https://gqlgen.com/](https://gqlgen.com/)
- GraphQL Playground: [http://localhost:8080/](http://localhost:8080/)

---

## License
This project is licensed under the **MIT License**.
